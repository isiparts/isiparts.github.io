try{let e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},t=(new e.Error).stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="60d546d2-1574-4e4b-85d4-1f0133e69ca2",e._sentryDebugIdIdentifier="sentry-dbid-60d546d2-1574-4e4b-85d4-1f0133e69ca2")}catch(A){}import{_ as e,u as t,t as r,T as i,b as a,R as o,c as s,P as n,d as l,e as d,f as c,h,S as m,g,r as u,j as p}from"./index-OdOCjMiI.js";import{n as w,a as f}from"./nav-Ck_lkINx.js";import"./call-bind-BFQqbmjp.js";import{M as v}from"./flowbite-Ln6Jbqyc.js";import{s as b}from"./signature-DTZB7ssX.js";import{E as $}from"./mec-B1V75Ai1.js";import"./@alpinejs/resize-CO1KAvJ_.js";import"./alpinejs-D043VxOM.js";import"./pinecone-router-DyexUCCX.js";import"./posthog-js-CcaH5niV.js";import"./node-polyglot-DlDlDF9m.js";import"./object.entries-DoVD67HD.js";import"./define-properties-JTyBPjo4.js";import"./object-keys-2-4LXbPU.js";import"./define-data-property-Dhkuw5U5.js";import"./es-define-property-BWOk23UV.js";import"./es-errors-CDnSFAF0.js";import"./gopd-DyUmdEtY.js";import"./has-property-descriptors-DsFaFEFP.js";import"./es-object-atoms-DlYjuSOe.js";import"./call-bound-BNSK0NEA.js";import"./get-intrinsic-Cxr_xTZv.js";import"./math-intrinsics-BRbcxSny.js";import"./has-symbols-B2_RGGVc.js";import"./get-proto-BRVA0OAU.js";import"./dunder-proto-DMCSAdn6.js";import"./call-bind-apply-helpers-BSpli2uY.js";import"./function-bind-DR49pCHT.js";import"./hasown-NUnpZb-C.js";import"./warning-Bp1nZ229.js";import"./@sentry/browser-Bk1Xewov.js";import"./@sentry/core-CnjMJUhl.js";import"./@sentry-internal/browser-utils-BUixo4nC.js";import"./@sentry-internal/replay-yt77ihwD.js";import"./set-function-length-BuPlcIl4.js";import"./config.service-YGUPWIw7.js";import"./@popperjs/core-IAo43KLY.js";import"./flowbite-datepicker-D6bDqdY1.js";import"./signature_pad-eDKSxAXg.js";const M="albaran",k="add-material",y="edit-material",O=[M,k,y],j={name:()=>"reference",template:()=>e((()=>import("./reference-DWTa3UWW.js")),[]),data:()=>({reference:"",origin:null,modalSearchRefer:null,marcas:[],familias:[],hasSearched:!1,loadingReferences:!1,selectedRefer:null,currentRefer:"",currentDesc:"",currentMarca:"",currentFamilia:"",referencias:[],paginationMetaData:null,currentPage:1,pageInfo:"",sortColumnKey:"",sortOrder:"asc",init(){console.log("reference@init"),this.initModalSearchRefer();["currentRefer","currentDesc","currentMarca","currentFamilia"].forEach((e=>{this.$watch(e,(()=>{this.hasSearched||(this.hasSearched=!0),1!==this.currentPage&&(this.currentPage=1),this.currentRefer.length<2&&this.currentDesc.length<2&&""===this.currentMarca&&""===this.currentFamilia&&this.resetValues()}))})),this.$nextTick((()=>{var e;console.log("101-reference@nextTick");const t=null==(e=this.$refs.form)?void 0:e.closest("[data-origin]");console.log("1-parent",t),console.log("2-origin",null==t?void 0:t.dataset.origin),console.log("3-condicion",void 0!==(null==t?void 0:t.dataset.origin)&&O.includes(null==t?void 0:t.dataset.origin)),void 0!==(null==t?void 0:t.dataset.origin)&&O.includes(null==t?void 0:t.dataset.origin)&&(this.origin=t.dataset.origin),this.$dispatch(l,{origin:this.origin})})),window.addEventListener(d,(e=>{console.log("99-reference@get",e.detail),console.log("99-origin",this.origin),e.detail.origin===this.origin&&(this.reference=e.detail.refer)})),window.addEventListener(c,(e=>{console.log("reference@clear",e.detail),this.reference=""})),window.addEventListener(o,(async e=>{var t,r;console.log("reference@not-found",e.detail),e.detail.origin===this.origin&&(this.currentRefer=e.detail.reference,null==(t=this.modalSearchRefer)||t.show(),null==(r=this.$refs.searchReferInput)||r.focus(),await this.searchRefer())}))},initModalSearchRefer(){this.modalSearchRefer=new v(this.$refs.modalSearchRefer,{placement:"center",backdrop:"static",backdropClasses:"bg-gray-900/50 dark:bg-gray-900/80 fixed inset-0 z-40",closable:!0,onHide:()=>{console.log("modal is hidden"),this.resetValues(),[this.currentRefer,this.currentDesc,this.currentMarca,this.currentFamilia]=["","","",""]},onShow:()=>{console.log("modal is shown")},onToggle:()=>{console.log("modal has been toggled")}},{id:"modal-search-refer",override:!0}),document.addEventListener(n,(()=>{var e;console.log("reference@page-visit"),null==(e=this.modalSearchRefer)||e.hide()}))},async prevPage(){this.currentPage>1&&(this.currentPage--,this.selectedRefer=null,await this.searchRefer())},async nextPage(){var e;this.currentPage<(null==(e=this.paginationMetaData)?void 0:e.totalPages)&&(this.currentPage++,this.selectedRefer=null,await this.searchRefer())},async openSearchReferModal(){var e;await Promise.all([this.loadMarcas(),this.loadFamilias()]),null==(e=this.modalSearchRefer)||e.show()},selectReferencia(e){this.selectedRefer=e},async setFormReference(){var e;if(null!==this.selectedRefer)try{const[t,r,i]=await Promise.all([this.getReferenceData(this.selectedRefer.refer),this.getPriceAndDiscount(this.selectedRefer.refer),this.getIvas(this.selectedRefer.refer)]);if(!t)throw new Error(this.$t("REFERENCE.not_found"));this.$dispatch(s,{referenceData:t,priceAndDiscount:r,ivas:i,origin:this.origin}),this.reference=this.selectedRefer.refer,null==(e=this.modalSearchRefer)||e.hide()}catch(t){console.log("error",t)}},async searchRefer(){const e=`${this.buildFilter()}&page=${this.currentPage}&pageSize=10&sort=${this.sortColumnKey}&order=${this.sortOrder}`;try{if(!e.startsWith("&page")){this.loadingReferences=!0;const r=await fetch(t(`/isiWeb/web/v1/empresas/01/referencias?${e}`),{credentials:"include",headers:{"Content-Type":"application/json"}});if(!r.ok)throw new Error(this.$t("Error al buscar referencias"));const i=await r.json();this.referencias=i.data,this.paginationMetaData=i.meta;const a=10*(this.currentPage-1)+1,o=Math.min(10*this.currentPage,this.paginationMetaData.totalRows);this.pageInfo=`Mostrando ${a} a ${o} de ${this.paginationMetaData.totalRows} registros`,this.loadingReferences=!1}}catch(r){console.log("error",r),this.resetValues(),this.loadingReferences=!1}},async sortReferencias(e){this.currentPage=1,this.sortColumnKey=e,this.sortOrder="asc"===this.sortOrder?"desc":"asc",await this.searchRefer()},resetValues(){this.pageInfo="",this.referencias=[],this.paginationMetaData=null,this.hasSearched=!1,this.loadingReferences=!1,this.selectedRefer=null},buildFilter(){let e="";return this.currentRefer.length>=2&&(e+=`refer:like=${this.currentRefer}`),this.currentDesc.length>=2&&(e+=""!==e?`&artde1:like=${this.currentDesc}`:`artde1:like=${this.currentDesc}`),""!==this.currentMarca&&(e+=""!==e?`&mar:like=${this.currentMarca}`:`mar:like=${this.currentMarca}`),""!==this.currentFamilia&&(e+=""!==e?`&fap:like=${this.currentFamilia}`:`fap:like=${this.currentFamilia}`),e},async loadMarcas(){try{const e=await fetch(t("/isiWeb/web/v1/empresas/01/marcas"),{credentials:"include",headers:{"Content-Type":"application/json"}});if(!e.ok)throw new Error(this.$t("Error al cargar marcas"));const r=await e.json();this.marcas=r.data}catch(e){console.log("error",e),this.$dispatch(i,{msg:e,level:a})}},async loadFamilias(){try{const e=await fetch(t("/isiWeb/web/v1/empresas/01/familias"),{credentials:"include",headers:{"Content-Type":"application/json"}});if(!e.ok)throw new Error(this.$t("Error al cargar familias"));const r=await e.json();this.familias=r.data}catch(e){console.log("error",e),this.$dispatch(i,{msg:e,level:a})}},async buildReference(e){const t=e.target.value;try{if(""!==t){const[e,r,i]=await Promise.all([this.getReferenceData(t),this.getPriceAndDiscount(t),this.getIvas(t)]);if(!e)return void this.$dispatch(o,{reference:t,origin:this.origin});this.$dispatch(s,{referenceData:e,priceAndDiscount:r,ivas:i,origin:this.origin})}}catch(r){console.log("error",r)}},async getReferenceData(e){try{const i=await fetch(t(`/isiWeb/web/v1/empresas/01/referencias/${e}`),{credentials:"include",headers:{"Content-Type":"application/json"}});if(!i.ok)throw new Error(r(i.statusText));return await i.json()}catch(o){console.log("error",o),404!==Number.parseInt(o.message)&&this.$dispatch(i,{msg:"Error al cargar datos de referencia",level:a})}},async getPriceAndDiscount(e){try{const i=await fetch(t(`/isiWeb/web/v1/empresas/01/referencias/${e}/precio`),{credentials:"include",headers:{"Content-Type":"application/json"}});if(!i.ok)throw new Error(r(i.statusText));return await i.json()}catch(o){console.log("error",o),404!==Number.parseInt(o.message)&&this.$dispatch(i,{msg:"Error al cargar datos de precios",level:a})}},async getIvas(e){try{const i=await fetch(t(`/isiWeb/web/v1/empresas/01/referencias/${e}/iva`),{credentials:"include",headers:{"Content-Type":"application/json"}});if(!i.ok)throw new Error(r(i.statusText));return await i.json()}catch(o){console.log("error",o),404!==Number.parseInt(o.message)&&this.$dispatch(i,{msg:"Error al cargar datos de IVA",level:a})}}})},E={A:"Avería",G:"Garantía",M:"Mantenimiento",P:"Pre-montaje",C:"Reconstrucción",J:"Montaje",R:"Reparación",T:"Taller",I:"Instalación",O:"Otros"},D={OR:"",artde1:"",canped:0,dtvdto:0,dtvdto2:0,dtvdto3:0,implnet:0,iva:"",linea:-1,precioCero:!1,pvp1:0,refer:""},R={OR:"",ejr:0,sef:"",cont:"",docum:0,civa:"",tiva:0,treq:0,impliva:0,implbas:0,implreq:0},W={name:()=>"workOrder",template:()=>e((()=>import("./work-order-edit-CcQcNXtw.js")),[]),data:()=>({error:null,user:null,nav:null,aside:null,signature:null,reference:null,loading:!0,loadingWorkOrderMecs:!1,loadingWorkOrderMaterials:!1,loadingWorkOrderDocs:!1,submitting:!1,workOrder:null,mecs:[],userMec:$,workOrderMecs:[],currentWorkOrderMec:null,workOrderMaterials:[],currentWorkOrderMaterial:D,workOrderIvas:R,adjuntos:[],currentAdjunto:null,tabs:[{id:0,text:"Albarán de reparación"},{id:1,text:"Mano de obra"},{id:2,text:"Material"},{id:3,text:"Adjuntos"}],currentTab:0,modalSign:null,clientSignature:null,mecSignature:null,modalMecAdd:null,modalMecDelete:null,modalMecEdit:null,modalMaterialAdd:null,modalMaterialDelete:null,modalMaterialEdit:null,modalAdjuntoAdd:null,modalAdjuntoDelete:null,modalAdjuntoView:null,async init(){console.log("work-order@init");try{this.user=await g()}catch(e){location.href="/login"}this.nav=await u(w),this.aside=await u(f),this.signature=await u(b),this.reference=await u(j),await Promise.all([this.loadWorkOrder(),this.loadMecs(),this.loadUserMec(),this.loadWorkOrderDocs()]),this.$watch("currentTab",(()=>{var e,t;0===this.currentTab&&(console.log("reference_get",null==(e=this.workOrder)?void 0:e.refer),this.$dispatch(d,{refer:null==(t=this.workOrder)?void 0:t.refer,origin:"albaran"})),1===this.currentTab&&this.loadWorkOrderMecs(),2===this.currentTab&&this.loadWorkOrderMaterials(),3===this.currentTab&&this.loadWorkOrderDocs()})),this.initModalSign(),this.initModalMecDelete(),this.initModalMecEdit(),this.initModalMecAdd(),this.initModalMaterialAdd(),this.initModalMaterialDelete(),this.initModalMaterialEdit(),this.initModalAdjuntoAdd(),this.initModalAdjuntoDelete(),this.initModalAdjuntoView(),this.$nextTick((()=>{console.log("101-work-order-edit@nextTick"),window.addEventListener(p,(e=>{var t;const r=null==(t=e.detail)?void 0:t.key;"client"===r&&(this.clientSignature=e.detail.value),"mec"===r&&(this.mecSignature=e.detail.value)})),window.addEventListener(m,(e=>{this.clientSignature=null,this.mecSignature=null})),window.addEventListener(s,(e=>{var t,r,i,a,o,s;if(console.log("REFERENCE_FOUND",e.detail),e.detail.origin===k){const a=null==(t=e.detail.referenceData)?void 0:t.data,o=null==(r=e.detail.priceAndDiscount)?void 0:r.data,s=null==(i=e.detail.ivas)?void 0:i.data;this.currentWorkOrderMaterial={OR:this.$params.or,artde1:a.artde1,canped:1,dtvdto:0|o.dtvdto,dtvdto2:0|o.dtvdto2,dtvdto3:0|o.dtvdto3,implnet:o.pvp,iva:s.iva,precioCero:!1,pvp1:o.pvp,refer:a.refer}}if(e.detail.origin===y){const t=null==(a=e.detail.referenceData)?void 0:a.data,r=null==(o=e.detail.priceAndDiscount)?void 0:o.data,i=null==(s=e.detail.ivas)?void 0:s.data;this.currentWorkOrderMaterial={...this.currentWorkOrderMaterial,artde1:t.artde1,iva:i.iva,pvp1:r.pvp,implnet:r.pvp,dtvdto:0|r.dtvdto,dtvdto2:0|r.dtvdto2,dtvdto3:0|r.dtvdto3}}})),window.addEventListener(l,(e=>{var t,r;(null==(t=e.detail)?void 0:t.origin)===M&&this.$dispatch(d,{refer:null==(r=this.workOrder)?void 0:r.refer,origin:M})}))})),this.loading=!1},initModalSign(){var e;this.modalSign=new v(this.$refs.modalSign,{placement:"center",backdrop:"static",backdropClasses:"bg-gray-900/50 dark:bg-gray-900/80 fixed inset-0 z-40",closable:!0,onHide:()=>{this.$dispatch(m)},onShow:()=>{console.log("modal is shown")},onToggle:()=>{console.log("modal has been toggled")}},{id:`modal-sign-${null==(e=this.workOrder)?void 0:e.OR}`,override:!0}),document.addEventListener(n,(()=>{var e;console.log("modalSign@page-visit"),null==(e=this.modalSign)||e.hide()}))},initModalMecDelete(){var e;this.modalMecDelete=new v(this.$refs.modalMecDelete,{placement:"center",backdrop:"dynamic",backdropClasses:"bg-gray-900/50 dark:bg-gray-900/80 fixed inset-0 z-40",closable:!0,onHide:()=>{console.log("modal is hidden")},onShow:()=>{console.log("modal is shown")},onToggle:()=>{console.log("modal has been toggled")}},{id:`modal-mec-delete-${null==(e=this.workOrder)?void 0:e.OR}`,override:!0}),document.addEventListener(n,(()=>{var e;console.log("modalMaterialDelete@page-visit"),null==(e=this.modalMaterialDelete)||e.hide()}))},initModalMecEdit(){var e;this.modalMecEdit=new v(this.$refs.modalMecEdit,{placement:"center",backdrop:"dynamic",backdropClasses:"bg-gray-900/50 dark:bg-gray-900/80 fixed inset-0 z-40",closable:!0,onHide:()=>{console.log("modal is hidden")},onShow:()=>{console.log("modal is shown")},onToggle:()=>{console.log("modal has been toggled")}},{id:`modal-mec-edit-${null==(e=this.workOrder)?void 0:e.OR}`,override:!0}),document.addEventListener(n,(()=>{var e;console.log("modalMecEdit@page-visit"),null==(e=this.modalMecEdit)||e.hide()}))},initModalMecAdd(){var e;this.modalMecAdd=new v(this.$refs.modalMecAdd,{placement:"center",backdrop:"dynamic",backdropClasses:"bg-gray-900/50 dark:bg-gray-900/80 fixed inset-0 z-40",closable:!0,onHide:()=>{console.log("modal is hidden")},onShow:()=>{console.log("modal is shown")},onToggle:()=>{console.log("modal has been toggled")}},{id:`modal-mec-add-${null==(e=this.workOrder)?void 0:e.OR}`,override:!0}),document.addEventListener(n,(()=>{var e;console.log("modalMecAdd@page-visit"),null==(e=this.modalMecAdd)||e.hide()}))},initModalAdjuntoDelete(){var e;this.modalAdjuntoDelete=new v(this.$refs.modalAdjuntoDelete,{placement:"center",backdrop:"dynamic",backdropClasses:"bg-gray-900/50 dark:bg-gray-900/80 fixed inset-0 z-40",closable:!0,onHide:()=>{console.log("modal is hidden")},onShow:()=>{console.log("modal is shown")},onToggle:()=>{console.log("modal has been toggled")}},{id:`modal-adjunto-delete-${null==(e=this.workOrder)?void 0:e.OR}`,override:!0}),document.addEventListener(n,(()=>{var e;console.log("modalAdjuntoDelete@page-visit"),null==(e=this.modalAdjuntoDelete)||e.hide()}))},initModalAdjuntoAdd(){var e;this.modalAdjuntoAdd=new v(this.$refs.modalAdjuntoAdd,{placement:"center",backdrop:"dynamic",backdropClasses:"bg-gray-900/50 dark:bg-gray-900/80 fixed inset-0 z-40",closable:!0,onHide:()=>{console.log("modal is hidden")},onShow:()=>{console.log("modal is shown")},onToggle:()=>{console.log("modal has been toggled")}},{id:`modal-adjunto-add-${null==(e=this.workOrder)?void 0:e.OR}`,override:!0}),document.addEventListener(n,(()=>{var e;console.log("modalAdjuntoAdd@page-visit"),null==(e=this.modalAdjuntoAdd)||e.hide()}))},initModalAdjuntoView(){var e;this.modalAdjuntoView=new v(this.$refs.modalAdjuntoView,{placement:"center",backdrop:"dynamic",backdropClasses:"bg-gray-900/50 dark:bg-gray-900/80 fixed inset-0 z-40",closable:!0,onHide:()=>{console.log("modal is hidden")},onShow:()=>{console.log("modal is shown")},onToggle:()=>{console.log("modal has been toggled")}},{id:`modal-adjunto-view-${null==(e=this.workOrder)?void 0:e.OR}`,override:!0}),document.addEventListener(n,(()=>{var e;console.log("modalAdjuntoView@page-visit"),null==(e=this.modalAdjuntoView)||e.hide()}))},initModalMaterialDelete(){var e;this.modalMaterialDelete=new v(this.$refs.modalMaterialDelete,{placement:"center",backdrop:"dynamic",backdropClasses:"bg-gray-900/50 dark:bg-gray-900/80 fixed inset-0 z-40",closable:!0,onHide:()=>{console.log("modal is hidden")},onShow:()=>{console.log("modal is shown")},onToggle:()=>{console.log("modal has been toggled")}},{id:`modal-material-delete-${null==(e=this.workOrder)?void 0:e.OR}`,override:!0}),document.addEventListener(n,(()=>{var e;console.log("modalMaterialDelete@page-visit"),null==(e=this.modalMaterialDelete)||e.hide()}))},initModalMaterialEdit(){var e;this.modalMaterialEdit=new v(this.$refs.modalMaterialEdit,{placement:"center",backdrop:"dynamic",backdropClasses:"bg-gray-900/50 dark:bg-gray-900/80 fixed inset-0 z-40",closable:!0,onHide:()=>{console.log("modal is hidden"),this.currentWorkOrderMaterial=D,this.$dispatch(c)},onShow:()=>{console.log("modal is shown")},onToggle:()=>{console.log("modal has been toggled")}},{id:`modal-material-edit-${null==(e=this.workOrder)?void 0:e.OR}`,override:!0}),document.addEventListener(n,(()=>{var e;console.log("modalMaterialEdit@page-visit"),null==(e=this.modalMaterialEdit)||e.hide()}))},initModalMaterialAdd(){var e;this.modalMaterialAdd=new v(this.$refs.modalMaterialAdd,{placement:"center",backdrop:"dynamic",backdropClasses:"bg-gray-900/50 dark:bg-gray-900/80 fixed inset-0 z-40",closable:!0,onHide:()=>{console.log("modal is hidden"),this.currentWorkOrderMaterial=D},onShow:()=>{console.log("modal is shown")},onToggle:()=>{console.log("modal has been toggled")}},{id:`modal-material-add-${null==(e=this.workOrder)?void 0:e.OR}`,override:!0}),document.addEventListener(n,(()=>{var e;console.log("modalMaterialAdd@page-visit"),null==(e=this.modalMaterialAdd)||e.hide()}))},async loadWorkOrder(){try{const e=await fetch(t(`/isiWeb/web/v1/empresas/01/ordenes-reparacion/${window.PineconeRouter.context.params.or}`),{credentials:"include",headers:{"Content-Type":"application/json"}}),r=await e.json();if(404===e.status)throw new Error(this.$t("WORKORDERS.or_not_found"));this.workOrder=r.data}catch(e){console.log(e),this.$dispatch(i,{msg:this.$t(e.toString()),level:a}),this.error=e.message}},async loadWorkOrderDocs(){this.loadingWorkOrderDocs=!0;try{const e=await fetch(t(`/isiWeb/web/v1/empresas/01/ordenes-reparacion/${window.PineconeRouter.context.params.or}/documentos?blob=false`),{credentials:"include",headers:{"Content-Type":"application/json"}}),r=await e.json();if(404===e.status)throw new Error(this.$t("WORKORDERS.or_not_found"));this.adjuntos=r.data}catch(e){console.log(e),this.$dispatch(i,{msg:this.$t(e.toString()),level:a}),this.error=e.toString()}this.loadingWorkOrderDocs=!1},async loadMecs(){try{const e="01",r=await fetch(t(`/isiWeb/web/v1/empresas/${e}/mecanicos`),{credentials:"include",headers:{"Content-Type":"application/json"}}),i=await r.json();if(404===r.status)throw new Error(this.$t("WORKORDERS.mec_not_found"));if(!r.ok)throw new Error(this.$t(r.statusText));this.mecs=i.data}catch(e){this.error=e.message,console.log(e),this.$dispatch(i,{msg:this.$t(e.toString()),level:a})}},async loadUserMec(){try{const e=await fetch(t(`/isiWeb/web/v1/empresas/01/mecanicos?usuario=${this.user.usuario}`),{credentials:"include",headers:{"Content-Type":"application/json"}});if(404===e.status)throw new Error(this.$t("WORKORDERS.mec_not_found"));if(!e.ok)throw new Error(this.$t(e.statusText));const r=await e.json();this.userMec=r.data[0]}catch(e){this.error=e.message,console.log(e),this.$dispatch(i,{msg:this.$t(e.toString()),level:a})}},async loadWorkOrderMecs(){this.loadingWorkOrderMecs=!0;try{const e=await fetch(t(`/isiWeb/web/v1/empresas/01/ordenes-reparacion/${window.PineconeRouter.context.params.or}/mecanicos`),{credentials:"include",headers:{"Content-Type":"application/json"}}),r=await e.json();if(404===e.status)throw new Error(this.$t("WORKORDERS.mec_not_found"));if(!e.ok)throw new Error(this.$t(e.statusText));this.workOrderMecs=r.data}catch(e){this.error=e.message,console.log(e),this.$dispatch(i,{msg:this.$t(e.toString()),level:a})}this.loadingWorkOrderMecs=!1},async loadWorkOrderMaterials(){this.loadingWorkOrderMaterials=!0;try{const e=await fetch(t(`/isiWeb/web/v1/empresas/01/ordenes-reparacion/${this.$params.or}/lineas`),{credentials:"include",headers:{"Content-Type":"application/json"}}),r=await e.json();if(404===e.status)throw new Error(this.$t("WORKORDERS.material_not_found"));if(!e.ok)throw new Error(this.$t(e.statusText));this.workOrderMaterials=r.data}catch(e){this.error=e.message,console.log(e),this.$dispatch(i,{msg:this.$t(e.toString()),level:a})}this.loadingWorkOrderMaterials=!1},async addAdjunto(e){var r;this.submitting=!0,this.loadingWorkOrderDocs=!0;const o=e.target,s=new FormData(o).get("file");let n={};if(s){const e=new FileReader;e.onload=async e=>{var r,o,l,d;const c=null==(r=e.target)?void 0:r.result,m={or:null==(o=this.workOrder)?void 0:o.OR,ejr:null==(l=this.workOrder)?void 0:l.ejr,sef:null==(d=this.workOrder)?void 0:d.sef,docum:1,numDocum:1,nombre:s.name,fecha:(new Date).toISOString().split("T")[0],hora:(new Date).toISOString().split("T")[1],descripcion:"",documento:c.split(",")[1]};n=m;try{const e=await fetch(t(`/isiWeb/web/v1/empresas/01/ordenes-reparacion/${this.$params.or}/documentos`),{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(n)});if(!e.ok){const t=await e.json();throw new Error(this.$t(t.message))}const r=await e.json();this.$dispatch(i,{msg:r.message,level:h}),await this.loadWorkOrderDocs()}catch(g){console.log("error",g),this.$dispatch(i,{msg:g,level:a})}finally{this.submitting=!1,this.loadingWorkOrderDocs=!1}},e.readAsDataURL(s)}null==(r=this.modalAdjuntoAdd)||r.hide()},async saveWorkOrderReference(e){console.log("saveWorkOrderReference",e);const r=new FormData(e.target),o=Object.fromEntries(r.entries()),s={...this.workOrder,refer:o.refer,numser:o.numser,reparacion:o.reparacion};this.submitting=!0;try{const e=await fetch(t(`/isiWeb/web/v1/empresas/01/ordenes-reparacion/${this.$params.or}`),{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(s)});if(!e.ok){const t=await e.json();throw new Error(this.$t(t.message))}const r=await e.json();console.log(r),this.workOrder=s,this.submitting=!1,this.$dispatch(i,{msg:`OR-${this.$params.or} Guardada correctamente`,level:h})}catch(n){this.$dispatch(i,{msg:n,level:a}),console.log("error",n),this.submitting=!1}},async openSignModal(){var e;console.log(this.workOrder),await this.loadWorkOrder(),await this.getIvas(),console.log(this.workOrderIvas),null==(e=this.modalSign)||e.show()},openAddAdjuntoModal(){var e,t;null==(e=this.$refs.formAttachAdjunto)||e.reset(),null==(t=this.modalAdjuntoAdd)||t.show()},async openViewAdjuntoModal(e){var r,o,s,n,l;try{const i=this.$refs.modalAdjuntoViewImage;let a;if(i.children.length>0&&i.removeChild(i.children[0]),"image/jpeg"!==e.mimeType&&"image/png"!==e.mimeType&&"image/jpg"!==e.mimeType||(a=document.createElement("img"),a.className="w-auto h-auto max-h-full",a.src=await this.generateAdjuntoUrl(`/isiWeb/web/v1/empresas/01/ordenes-reparacion/${null==(r=this.workOrder)?void 0:r.OR}/documentos/${e.numDocum}/previsualiza`),i.appendChild(a)),e.nombre.endsWith(".mp4")||e.nombre.endsWith(".webm")){a=document.createElement("video"),a.width=640,a.height=480,a.controls=!0;const t=document.createElement("source");t.src=await this.generateAdjuntoUrl(`/isiWeb/web/v1/empresas/01/ordenes-reparacion/${null==(o=this.workOrder)?void 0:o.OR}/documentos/${e.numDocum}/previsualiza`),a.appendChild(t),i.appendChild(a)}if("application/pdf"===e.mimeType){const r=await fetch(t(`/isiWeb/web/v1/empresas/01/ordenes-reparacion/${null==(s=this.workOrder)?void 0:s.OR}/documentos/${e.numDocum}`),{credentials:"include",headers:{"Content-Type":"application/json"}}),o=await r.json();if(!r.ok)throw new Error(this.$t(o.message));const l=o.data;a=document.createElement("object"),a.type="application/pdf",a.className="w-full h-full max-h-full",a.data=`data:${e.mimeType};base64, ${l.documento}`;const d=document.createElement("p"),c=document.createElement("a");c.href=await this.generateAdjuntoUrl(`/isiWeb/web/v1/empresas/01/ordenes-reparacion/${null==(n=this.workOrder)?void 0:n.OR}/documentos/${e.numDocum}/previsualiza`),c.target="_blank",c.textContent=`${e.nombre}`,c.className="text-primary-600",d.textContent="Visualizar ",d.className="text-center",d.appendChild(c),a.appendChild(d),i.appendChild(a)}null==(l=this.modalAdjuntoView)||l.show()}catch(d){console.log(d),this.$dispatch(i,{msg:this.$t(d.toString()),level:a})}},openDeleteAdjuntoModal(e){var t;this.currentAdjunto=e,null==(t=this.modalAdjuntoDelete)||t.show()},openAddMecModal(){var e,t;null==(e=this.$refs.formMecAdd)||e.reset(),null==(t=this.modalMecAdd)||t.show()},openEditMecModal(e){var t;this.currentWorkOrderMec={...e},null==(t=this.modalMecEdit)||t.show()},openEditMaterialModal(e){var t;this.currentWorkOrderMaterial={...e},this.$dispatch(d,{refer:this.currentWorkOrderMaterial.refer,origin:y}),null==(t=this.modalMaterialEdit)||t.show()},openAddMaterialModal(){var e;this.$dispatch(c),null==(e=this.modalMaterialAdd)||e.show()},openDeleteMecModal(e){var t;this.currentWorkOrderMec=e,null==(t=this.modalMecDelete)||t.show()},openDeleteMaterialModal(e){var t;this.currentWorkOrderMaterial=e,null==(t=this.modalMaterialDelete)||t.show()},async addMec(e){var r;const o=new FormData(e.target),s=Object.fromEntries(o.entries());console.log("newMec",s);try{this.submitting=!0;const e=await fetch(t(`/isiWeb/web/v1/empresas/01/ordenes-reparacion/${this.$params.or}/mecanicos`),{credentials:"include",method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({OR:this.$params.or,intDes:s.intDes,fecint:s.fecint,horDes:+s.horDes,mec:+s.mec,kmDes:+s.kmDes,horTra:+s.horTra,facturar:"on"===s.facturar})});if(!e.ok){const t=await e.json();throw new Error(this.$t(t.message))}await this.loadWorkOrderMecs(),null==(r=this.modalMecAdd)||r.hide(),this.submitting=!1,this.$dispatch(i,{msg:"Mecánico añadido correctamente",level:h})}catch(n){console.log("error",n),this.submitting=!1,this.$dispatch(i,{msg:this.$t(n.toString()),level:a})}},async editMec(e){var r;const o=new FormData(e.target),s=Object.fromEntries(o.entries()),n=!!s.facturar||this.currentWorkOrderMec.facturar;try{this.submitting=!0;const e=await fetch(t(`/isiWeb/web/v1/empresas/01/ordenes-reparacion/${this.$params.or}/mecanicos/${this.currentWorkOrderMec.linea}`),{credentials:"include",method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({OR:this.$params.or,intDes:s.intDes,fecint:s.fecint,horDes:+s.horDes,mec:+s.mec,kmDes:+s.kmDes,horTra:+s.horTra,facturar:n})});if(!e.ok){const t=await e.json();throw new Error(this.$t(t.message))}await this.loadWorkOrderMecs(),this.currentWorkOrderMec=null,null==(r=this.modalMecEdit)||r.hide(),this.submitting=!1,this.$dispatch(i,{msg:"Mecánico editado correctamente",level:h})}catch(l){this.submitting=!1,this.$dispatch(i,{msg:this.$t(l.toString()),level:a}),console.log("error",l)}},async deleteMec(e){var r;try{this.submitting=!0;const a=await fetch(t(`/isiWeb/web/v1/empresas/01/ordenes-reparacion/${this.$params.or}/mecanicos/${e.linea}`),{credentials:"include",headers:{"Content-Type":"application/json"},method:"DELETE"});if(!a.ok){const e=await a.json();throw new Error(this.$t(e.message))}await this.loadWorkOrderMecs(),this.currentWorkOrderMec=null,null==(r=this.modalMecDelete)||r.hide(),this.submitting=!1,this.$dispatch(i,{msg:"Mecánico eliminado correctamente",level:h})}catch(o){console.log("error",o),this.submitting=!1,this.$dispatch(i,{msg:this.$t(o.toString()),level:a})}},async addMaterial(){var e;try{if(this.submitting=!0,this.currentWorkOrderMaterial.canped<=0)throw new Error(this.$t("WORKORDERS.min_quantity_gt_zero"));const r=await fetch(t(`/isiWeb/web/v1/empresas/01/ordenes-reparacion/${this.$params.or}/lineas`),{credentials:"include",method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.currentWorkOrderMaterial)});if(!r.ok){const e=await r.json();throw new Error(this.$t(e.message))}await this.loadWorkOrderMaterials(),this.currentWorkOrderMaterial={OR:this.$params.or,artde1:"",canped:1,dtvdto:0,dtvdto2:0,dtvdto3:0,implnet:0,iva:"",precioCero:!1,pvp1:0,refer:""},this.submitting=!1,this.$dispatch(c),this.$dispatch(i,{msg:"Material añadido correctamente",level:h}),null==(e=this.modalMaterialAdd)||e.hide()}catch(r){console.log("error",r),this.submitting=!1,this.$dispatch(i,{msg:this.$t(r.toString()),level:a})}},async editMaterial(e){var r;const o=new FormData(e.target),s=Object.fromEntries(o.entries());console.log("currentWorkOrderMaterial",this.currentWorkOrderMaterial);try{this.submitting=!0;const e=await fetch(t(`/isiWeb/web/v1/empresas/01/ordenes-reparacion/${this.$params.or}/lineas/${this.currentWorkOrderMaterial.linea}`),{credentials:"include",method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({OR:this.$params.or,artde1:s.artde1,canped:+s.canped,refer:s.refer,pvp1:this.currentWorkOrderMaterial.pvp1,implnet:this.currentWorkOrderMaterial.implnet,iva:this.currentWorkOrderMaterial.iva,dtvdto:this.currentWorkOrderMaterial.dtvdto,dtvdto2:this.currentWorkOrderMaterial.dtvdto2,dtvdto3:this.currentWorkOrderMaterial.dtvdto3,precioCero:this.currentWorkOrderMaterial.precioCero})});if(!e.ok){const t=await e.json();throw new Error(this.$t(t.message))}await this.loadWorkOrderMaterials(),this.currentWorkOrderMaterial=D,null==(r=this.modalMaterialEdit)||r.hide(),this.submitting=!1,this.$dispatch(c),this.$dispatch(i,{msg:"Material editado correctamente",level:h})}catch(n){console.log("error",n),this.submitting=!1,this.$dispatch(i,{msg:this.$t(n.toString()),level:a})}},async deleteMaterial(e){var r;try{this.submitting=!0;const a=await fetch(t(`/isiWeb/web/v1/empresas/01/ordenes-reparacion/${this.$params.or}/lineas/${e.linea}`),{credentials:"include",headers:{"Content-Type":"application/json"},method:"DELETE"});if(!a.ok){const e=await a.json();throw new Error(this.$t(e.message))}await this.loadWorkOrderMaterials(),this.currentWorkOrderMaterial=D,null==(r=this.modalMaterialDelete)||r.hide(),this.submitting=!1,this.$dispatch(i,{msg:"Material eliminado correctamente",level:h})}catch(o){console.log("error",o),this.submitting=!1,this.$dispatch(i,{msg:this.$t(o.toString()),level:a})}},async deleteAdjunto(e){var r;try{this.submitting=!0;const a=await fetch(t(`/isiWeb/web/v1/empresas/01/ordenes-reparacion/${this.$params.or}/documentos/${e.numDocum}`),{credentials:"include",headers:{"Content-Type":"application/json"},method:"DELETE"});if(!a.ok){const e=await a.json();throw new Error(this.$t(e.message))}const o=await a.json();await this.loadWorkOrderDocs(),null==(r=this.modalAdjuntoDelete)||r.hide(),this.submitting=!1,this.$dispatch(i,{msg:o.message,level:h})}catch(o){console.log("error",o),this.submitting=!1,this.$dispatch(i,{msg:this.$t(o.toString()),level:a})}},async getIvas(){var e;try{const r=await fetch(t(`/isiWeb/web/v1/empresas/01/ordenes-reparacion/${this.$params.or}/ivas?almnro=${null==(e=this.workOrder)?void 0:e.almnro}`),{credentials:"include",headers:{"Content-Type":"application/json"}});if(!r.ok){const e=await r.json();throw new Error(this.$t(e.message))}const i=await r.json();this.workOrderIvas=i.data.length>0?i.data[0]:R}catch(r){console.log("error",r),this.$dispatch(i,{msg:this.$t(r.toString()),level:a})}},tipRepValue(){const e=this.workOrder;return(null==e?void 0:e.tiprep)?E[e.tiprep]:""},generateAdjuntoUrl:async e=>t(e),async finalizeWorkOrder(){var e;const r=[this.clientSignature,this.mecSignature];try{for(let e=0;e<r.length;e++){const a=await fetch(t(`isiWeb/web/v1/empresas/01/ordenes-reparacion/${this.$params.or}/firma`),{credentials:"include",method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({origen:0===e?"firmaCliente":"firmaMecanico",adjunto:r[e].substring(r[e].indexOf(",")+1)})});if(!a.ok){const e=await a.json();throw new Error(this.$t(e.message))}this.$dispatch(i,{msg:`OR-${this.$params.or} finalizada correctamente`,level:h})}null==(e=this.modalSign)||e.hide(),this.$router.navigate("/or/list")}catch(o){console.log("error",o),this.$dispatch(i,{msg:this.$t(o.toString()),level:a})}}})};export{W as default};
//# sourceMappingURL=work-order-edit-DgAQX4aj.js.map
