try{let t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},e=(new t.Error).stack;e&&(t._sentryDebugIds=t._sentryDebugIds||{},t._sentryDebugIds[e]="156ef6c8-0854-4cce-b52a-fcca46dc4bd7",t._sentryDebugIdIdentifier="sentry-dbid-156ef6c8-0854-4cce-b52a-fcca46dc4bd7")}catch(m){}import{_ as t,u as e,S as i,T as s,h as n,b as o,g as r,r as a,j as c}from"./index-OdOCjMiI.js";import{s as l}from"./signature-DTZB7ssX.js";import"./call-bind-BFQqbmjp.js";import{l as d}from"./config.service-YGUPWIw7.js";import{P as h}from"./pusher-js-DKnSmxnV.js";import"./@alpinejs/resize-CO1KAvJ_.js";import"./alpinejs-D043VxOM.js";import"./pinecone-router-DyexUCCX.js";import"./posthog-js-CcaH5niV.js";import"./node-polyglot-DlDlDF9m.js";import"./object.entries-DoVD67HD.js";import"./define-properties-JTyBPjo4.js";import"./object-keys-2-4LXbPU.js";import"./define-data-property-Dhkuw5U5.js";import"./es-define-property-BWOk23UV.js";import"./es-errors-CDnSFAF0.js";import"./gopd-DyUmdEtY.js";import"./has-property-descriptors-DsFaFEFP.js";import"./es-object-atoms-DlYjuSOe.js";import"./call-bound-BNSK0NEA.js";import"./get-intrinsic-Cxr_xTZv.js";import"./math-intrinsics-BRbcxSny.js";import"./has-symbols-B2_RGGVc.js";import"./get-proto-BRVA0OAU.js";import"./dunder-proto-DMCSAdn6.js";import"./call-bind-apply-helpers-BSpli2uY.js";import"./function-bind-DR49pCHT.js";import"./hasown-NUnpZb-C.js";import"./warning-Bp1nZ229.js";import"./@sentry/browser-Bk1Xewov.js";import"./@sentry/core-CnjMJUhl.js";import"./@sentry-internal/browser-utils-BUixo4nC.js";import"./@sentry-internal/replay-yt77ihwD.js";import"./set-function-length-BuPlcIl4.js";import"./signature_pad-eDKSxAXg.js";var u=(t=>(t.MOSTRADOR="mostrador",t))(u||{}),p=(t=>(t.MOSTRADOR_FIRMA="mostrador-firma",t.MOSTRADOR_CANCELAR="mostrador-cancelar",t))(p||{});const g={name:()=>"documentSign",template:()=>t((()=>import("./isisign-CacYev4t.js")),[]),data:()=>({waiting:!0,user:null,config:d(),signature:null,signatureImage:null,signatureWidth:0,signatureHeight:0,docs:new Map,currentDoc:null,async init(){console.log("isisign@init");try{this.user=await r()}catch(t){location.href="/login?redirect=/isisign"}await this.handlePusherEvents(),this.$nextTick((async()=>{const t=window.innerHeight-25,e=window.innerWidth-50;this.signatureWidth=e<300?300:e>600?600:e,this.signatureHeight=t<300?300:t>400?400:t,this.signature=await a(l),window.addEventListener(c,(t=>{var e,i;"mostrador"===(null==(e=t.detail)?void 0:e.key)&&(this.signatureImage=null==(i=t.detail)?void 0:i.value)})),window.addEventListener(i,(t=>{this.signatureImage=null}))}))},async handlePusherEvents(){if(!this.config.documentSign.pusher.enabled)return void console.warn("Pusher is disabled");console.log("Pusher is enabled");const t=new h(this.config.documentSign.pusher.key,this.config.documentSign.pusher.options);t.connection.bind("state_change",(t=>{console.log(`Connection state changed from ${t.previous} to ${t.current}`)})),t.connection.bind("error",(t=>{console.error("Connection error:",t)})),t.connection.bind("connected",(()=>{console.info("Connected to Pusher")})),t.connection.bind("failed",(()=>{console.error("Pusher failed"),location.reload()}));const e=t.subscribe(u.MOSTRADOR);e.bind(p.MOSTRADOR_FIRMA,(t=>{this.config.documentSign.queue||(this.docs.clear(),this.currentDoc=null,this.signatureImage=null,this.waiting=!0,this.$dispatch(i)),this.docs.set(t.id,t),console.log("Pusher event",this.docs),null===this.currentDoc&&this.nextDoc()})),e.bind(p.MOSTRADOR_CANCELAR,(()=>{console.log("Pusher event cancel"),this.docs.clear(),this.currentDoc=null,this.signatureImage=null,this.waiting=!0,this.$dispatch(i)}))},async handleSignature(){var t,r;try{if(null===this.currentDoc||null===this.signatureImage)return;this.waiting=!0;const i=await fetch(e(`/isiSign/auth.jsp?doc=${this.currentDoc.id}`),{method:"POST",headers:{Authorization:`Basic ${btoa(`${(null==(t=this.user)?void 0:t.usuario)||""}:${(null==(r=this.user)?void 0:r.empOmi)||""}`)}`,Accept:"application/json"}});for(const[t,e]of i.headers.entries())console.log(`Header: ${t} = ${e}`);const o=i.headers.get("Authorization")||"";if(console.log("Authorization",o),!i.ok||!o)throw new Error(this.$t("AUTH.not_authenticated"));if(!(await fetch(e("/isiSign/storeSignature.jsp"),{method:"POST",headers:{Authorization:o,Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({id:this.currentDoc.id,blob:this.signatureImage.substring(this.signatureImage.indexOf(",")+1)})})).ok)throw new Error("Error signing document");console.log("antes",this.docs),this.docs.delete(this.currentDoc.id),console.log("despues",this.docs),this.$dispatch(s,{msg:`Firma ${this.currentDoc.id} enviada`,level:n}),this.currentDoc=null,this.nextDoc()}catch(a){console.error(a),this.$dispatch(s,{msg:a,level:o}),setTimeout((()=>{this.docs.clear(),this.currentDoc=null,this.signatureImage=null,this.$dispatch(i),this.waiting=!0}),1e3)}},nextDoc(){if(null!==this.currentDoc||0===this.docs.size)return;const t=Array.from(this.docs.entries()),e=t[t.length-1];this.currentDoc=e[1],this.currentDoc&&(this.$dispatch(i),this.waiting=!1)},async currentDocClient(){var t;if(null===this.currentDoc)return"";const i=await fetch(e(`/isiWeb/web/v1/empresas/01/clientes?cli:=${null==(t=this.currentDoc)?void 0:t.cliente}`),{method:"GET",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json"}});if(!i.ok)return console.error("Error fetching client"),"";const s=await i.json();return s.data&&0!==s.data.length?s.data[0].raz:(console.error("Client not found"),"")}})};export{g as default};
//# sourceMappingURL=isisign-CSN1ts4j.js.map
